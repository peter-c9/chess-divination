<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="color-scheme" content="only light">
<title>象棋三合一占卜終端 - 極限免滾動版</title>
<style>
  :root { 
    --board-bg: #f2c029; --line-color: #000000; --piece-white: #ffffff;
    --dodger-blue: #1E90FF; --hot-pink: #FF69B4; --gold: #FFD700;
  }
  body { font-family: "Microsoft JhengHei", "Kaiti", serif; background: #121212 !important; color: #e0e0e0 !important; padding: 10px; display: flex; flex-direction: column; align-items: center; margin: 0; box-sizing: border-box; }
  
  .main-container { width: 100%; max-width: 500px; box-sizing: border-box; }

  /* 模式切換 */
  .mode-switch { display: flex; background: #333; border-radius: 25px; padding: 5px; margin-bottom: 12px; width: 100%; }
  .mode-btn { flex: 1; text-align: center; padding: 8px; border-radius: 20px; cursor: pointer; font-weight: bold; }
  .mode-btn.active { background: #555; color: #fff; box-shadow: 0 0 5px rgba(255,255,255,0.2); }

  /* 32子數字鍵面板 */
  .grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; margin-bottom: 15px; width: 100%; }
  .card { width: 100%; aspect-ratio: 1/1; text-align: center; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; border-radius: 4px; font-weight: 900; position: relative; font-size: 24px; transition: 0.2s; box-sizing: border-box; }
  .card.draw-mode { background: var(--dodger-blue) !important; color: #ffffff !important; border-color: #0d73d9; }
  .card.layout-mode { background: #eee !important; }
  .card.red-text { color: #d32f2f !important; }
  .card.black-text { color: #212121 !important; }
  .card .seq { position: absolute; top: -4px; right: -4px; background: #FF3D00; color: #fff; font-size: 10px; width: 16px; height: 16px; line-height: 16px; border-radius: 50%; display: none; z-index: 10; border: 1px solid white; box-shadow: 0 0 3px #000; }
  .card.revealed { background: #444 !important; color: #888 !important; pointer-events: none; opacity: 0.8; }
  .card.revealed .seq { display: block; }

  /* 截圖區與輸出區 */
  .screenshot-area { background: #1e1e1e !important; padding: 12px; border-radius: 12px; border: 2px solid #444; margin-bottom: 15px; width: 100%; box-sizing: border-box; }
  .palace-board { background: var(--board-bg) !important; width: 160px; height: 160px; margin: 20px auto; position: relative; border: 4px solid var(--line-color); }
  .line { position: absolute; background: var(--line-color) !important; }
  .line-h { width: 100%; height: 3px; left: 0; } .line-v { height: 100%; width: 3px; top: 0; }
  .h-mid { top: 50%; transform: translateY(-50%); } .v-mid { left: 50%; transform: translateX(-50%); }
  .line-x { width: 141.4%; height: 3px; top: 0; left: 0; transform-origin: top left; transform: rotate(45deg); }
  .line-x2 { width: 141.4%; height: 3px; top: 0; right: 0; transform-origin: top right; transform: rotate(-45deg); }
  
  .piece { width: 56px; height: 56px; background: #fff !important; border-radius: 50%; border: 3px solid #000 !important; display: none; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; position: absolute; transform: translate(-50%, -50%); z-index: 20; color: #000 !important; box-shadow: 2px 4px 8px rgba(0,0,0,0.4); }
  .piece.red { color: #d32f2f !important; }
  #v-mid { top: 50%; left: 50%; } #v-left { top: 50%; left: 0; } #v-right { top: 50%; left: 100%; } #v-up { top: 0; left: 50%; } #v-down { top: 100%; left: 50%; }

  /* 數理圖案區 */
  .math-display { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 12px 10px; margin-top: 10px; display: none; flex-direction: column; gap: 15px; }
  .gua-block { width: 100%; display: flex; flex-direction: column; align-items: center; }
  .gua-title { font-weight: bold; margin-bottom: 8px; font-size: 16px; color: var(--gold); display: flex; align-items: center; width: 100%; justify-content: center; }
  
  .btn-info { background: #444; color: #fff; border: 1px solid #777; border-radius: 6px; padding: 8px 16px; font-size: 14px; font-weight: bold; cursor: pointer; margin-left: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  
  .yao-line { display: flex; align-items: center; width: 100%; justify-content: center; font-family: monospace; font-size: 14px; margin: 2px 0; color: #ccc; }
  .yao-bar { font-size: 15px; margin-right: 12px; letter-spacing: -1px; }
  .yao-text { text-align: left; min-width: 100px; } 
  .moving-yao { color: #ff3366; font-weight: bold; }

  /* 控制區 */
  .controls { background: #1e1e1e; padding: 15px; border-radius: 12px; width: 100%; box-sizing: border-box; }
  .quick-tags { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 6px; }
  .tag-btn { background: #2a2a2a; color: var(--gold); border: 1px solid var(--gold); padding: 5px 10px; border-radius: 15px; font-size: 12px; }
  
  .btn-row { display: flex; gap: 6px; width: 100%; margin-bottom: 10px; }
  .btn-prompt { flex: 1; padding: 12px 0; border: none; border-radius: 6px; font-weight: bold; font-size: 15px; text-align: center; color: #000; }
  .bg-xq { background: var(--dodger-blue); } .bg-zs { background: #ffffff; } .bg-mh { background: var(--hot-pink); } .bg-all { background: var(--gold); }

  .action-row { display: flex; gap: 8px; width: 100%; }
  .btn-action { background: #444; color: white; flex: 1; padding: 12px; font-weight: bold; border-radius: 6px; border: none; font-size: 14px; }
  #output { width: 100%; background: #000; color: #fff; border: 1px solid var(--gold); padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 10px; box-sizing: border-box; line-height: 1.5; }

  /* 彈出視窗：極限壓縮高度 */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; }
  .modal-content { background: #1a1a1a; border: 1px solid var(--gold); border-radius: 8px; padding: 10px 12px; width: 94%; max-width: 420px; color: #fff; position: relative; max-height: 95vh; overflow-y: hidden; }
  .modal-title { text-align: center; color: var(--gold); font-size: 17px; margin-top: 0; margin-bottom: 8px; font-weight: bold; }
  .modal-close { display: block; width: 100%; background: #d32f2f; color: white; text-align: center; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; border: none; margin-top: 8px; font-size: 16px; }
</style>
</head>
<body>

<div class="main-container">
  <div class="mode-switch">
    <div id="mode-draw" class="mode-btn active" onclick="switchMode('draw')">抽卦模式</div>
    <div id="mode-layout" class="mode-btn" onclick="switchMode('layout')">擺卦模式</div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="screenshot-area">
    <div id="cur-date" style="text-align: center; font-size: 13px; color: var(--gold); margin-bottom: 8px; font-weight: bold;"></div>
    
    <div class="palace-board">
      <div class="line line-h h-mid"></div><div class="line line-h" style="top:0;"></div><div class="line line-h" style="bottom:0;"></div>
      <div class="line line-v v-mid"></div><div class="line line-v" style="left:0;"></div><div class="line line-v" style="right:0;"></div>
      <div class="line line-x"></div><div class="line line-x2"></div>
      <div id="v-up" class="piece"></div><div id="v-left" class="piece"></div><div id="v-mid" class="piece"></div><div id="v-right" class="piece"></div><div id="v-down" class="piece"></div>
    </div>

    <div id="math-box" class="math-display">
      <div class="gua-block" id="zs-graph"></div>
      <div class="gua-block" id="mh-graph"></div>
    </div>
    
    <textarea id="output" rows="8" placeholder="生成的提示詞..." readonly></textarea>
  </div>

  <div class="controls">
    <div style="margin-bottom:10px; display:flex; gap:10px;">
      性別：<select id="gender" style="flex:1; padding:8px;"><option value="男">男</option><option value="女">女</option></select>
      婚姻：<select id="marriage" style="flex:1; padding:8px;"><option value="已婚">已婚</option><option value="未婚">未婚</option></select>
    </div>
    <div class="quick-tags" id="tag-container"></div>
    <input type="text" id="subject" placeholder="求問事項..." style="width:100%; padding:10px; box-sizing:border-box; margin-bottom:10px; background:#2a2a2a; color:#fff; border:1px solid #444; border-radius:4px;">
    
    <div class="btn-row">
      <button class="btn-prompt bg-xq" onclick="generatePrompt('xq')">象棋</button>
      <button class="btn-prompt bg-zs" onclick="generatePrompt('zs')">六爻</button>
      <button class="btn-prompt bg-mh" onclick="generatePrompt('mh')">梅花</button>
      <button class="btn-prompt bg-all" onclick="generatePrompt('all')">彙總</button>
    </div>
    
    <div class="action-row">
      <button class="btn-action" onclick="resetAll()">重新開始</button>
      <button class="btn-action" style="background:#006600;" onclick="copyToClipboard()">複製提示詞</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-zs" onclick="closeModal(event, 'modal-zs')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 class="modal-title">六爻虛擬子餘數換算表 (1~32)</h3>
    <div id="zs-grid-container"></div>
    <button class="modal-close" onclick="closeModal(null, 'modal-zs')">關閉視窗</button>
  </div>
</div>
<div class="modal-overlay" id="modal-mh" onclick="closeModal(event, 'modal-mh')">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 class="modal-title">梅花上下卦餘數換算表</h3>
    <div id="mh-grid-container"></div>
    <button class="modal-close" onclick="closeModal(null, 'modal-mh')">關閉視窗</button>
  </div>
</div>

<script>
  const pieces = [
    {n:'帥', c:'red', p:80, t:'old'},{n:'仕', c:'red', p:60, t:'old'},{n:'仕', c:'red', p:60, t:'old'},
    {n:'相', c:'red', p:40, t:'old'},{n:'相', c:'red', p:40, t:'old'},{n:'俥', c:'red', p:30, t:'old'},
    {n:'俥', c:'red', p:30, t:'old'},{n:'傌', c:'red', p:20, t:'old'},{n:'傌', c:'red', p:20, t:'old'},
    {n:'炮', c:'red', p:15, t:'old'},{n:'炮', c:'red', p:15, t:'old'},{n:'兵', c:'red', p:10, t:'young'},
    {n:'兵', c:'red', p:10, t:'young'},{n:'兵', c:'red', p:10, t:'young'},{n:'兵', c:'red', p:10, t:'young'},{n:'兵', c:'red', p:10, t:'young'},
    {n:'將', c:'black', p:80, t:'old'},{n:'士', c:'black', p:60, t:'old'},{n:'士', c:'black', p:60, t:'old'},
    {n:'象', c:'black', p:40, t:'old'},{n:'象', c:'black', p:40, t:'old'},{n:'車', c:'black', p:30, t:'old'},
    {n:'車', c:'black', p:30, t:'old'},{n:'馬', c:'black', p:20, t:'old'},{n:'馬', c:'black', p:20, t:'old'},
    {n:'包', c:'black', p:15, t:'old'},{n:'包', c:'black', p:15, t:'old'},{n:'卒', c:'black', p:10, t:'young'},
    {n:'卒', c:'black', p:10, t:'young'},{n:'卒', c:'black', p:10, t:'young'},{n:'卒', c:'black', p:10, t:'young'},{n:'卒', c:'black', p:10, t:'young'}
  ];

  const virtualPieces = [
    null, {n:'帥', c:'red'}, {n:'將', c:'black'}, {n:'仕', c:'red'}, {n:'士', c:'black'}, {n:'仕', c:'red'}, {n:'士', c:'black'},
    {n:'相', c:'red'}, {n:'象', c:'black'}, {n:'相', c:'red'}, {n:'象', c:'black'}, {n:'傌', c:'red'}, {n:'馬', c:'black'},
    {n:'傌', c:'red'}, {n:'馬', c:'black'}, {n:'俥', c:'red'}, {n:'車', c:'black'}, {n:'俥', c:'red'}, {n:'車', c:'black'},
    {n:'炮', c:'red'}, {n:'包', c:'black'}, {n:'炮', c:'red'}, {n:'包', c:'black'}, {n:'兵', c:'red'}, {n:'卒', c:'black'},
    {n:'兵', c:'red'}, {n:'卒', c:'black'}, {n:'兵', c:'red'}, {n:'卒', c:'black'}, {n:'兵', c:'red'}, {n:'卒', c:'black'},
    {n:'兵', c:'red'}, {n:'卒', c:'black'}
  ];

  const mhData = [
    { r: 1, n: '乾', s: '☰', t: '天', e: '金' }, { r: 2, n: '兌', s: '☱', t: '澤', e: '金' },
    { r: 3, n: '離', s: '☲', t: '火', e: '火' }, { r: 4, n: '震', s: '☳', t: '雷', e: '木' },
    { r: 5, n: '巽', s: '☴', t: '風', e: '木' }, { r: 6, n: '坎', s: '☵', t: '水', e: '水' },
    { r: 7, n: '艮', s: '☶', t: '山', e: '土' }, { r: '8/0', n: '坤', s: '☷', t: '地', e: '土' }
  ];

  const guaNames = ["", "乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
  const guaBars = {1:[1,1,1], 2:[1,1,0], 3:[1,0,1], 4:[1,0,0], 5:[0,1,1], 6:[0,1,0], 7:[0,0,1], 8:[0,0,0]};
  
  let currentMode = 'draw', selected = [];

  function getFormattedDate() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, '0');
    const d = String(now.getDate()).padStart(2, '0');
    const hh = String(now.getHours()).padStart(2, '0');
    const mm = String(now.getMinutes()).padStart(2, '0');
    let lunar = "";
    try {
      const f = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', {year:'numeric', month:'long', day:'numeric'});
      lunar = ` (農曆 ${f.format(now)})`;
    } catch (e) {}
    return `${y}年${m}月${d}日 ${hh}:${mm}${lunar}`;
  }

  // 六爻表格：縮小間距與 Padding
  function populateZSTable() {
    let html = '';
    for(let i=1; i<=32; i++) {
      let p = virtualPieces[i];
      let color = p.c === 'red' ? '#ff4d4d' : '#cccccc';
      html += `<div style="background:#2a2a2a; border:1px solid #444; border-radius:6px; padding:4px 2px; display:flex; align-items:center; justify-content:center; gap:4px;"><div style="font-size:15px; font-weight:bold; color:var(--gold);">${i}</div><div style="font-size:20px; font-weight:900; color:${color}; font-family:'Kaiti'; line-height:1;">${p.n}</div></div>`;
    }
    const container = document.getElementById('zs-grid-container');
    container.style.display = 'grid'; container.style.gridTemplateColumns = 'repeat(4, 1fr)'; container.style.gap = '5px';
    container.innerHTML = html;
  }

  // 梅花表格：極致壓縮 Padding 確保不超出畫面
  function populateMHTable() {
    let html = '';
    mhData.forEach(d => {
      html += `<div style="background:#2a2a2a; border:1px solid #444; border-radius:6px; padding:6px 12px; display:flex; align-items:center; justify-content:space-between; line-height:1;"><div style="font-size:20px; font-weight:bold; color:var(--gold); width:35px;">${d.r}</div><div style="font-size:28px; font-weight:900; color:#fff; font-family:'Kaiti'; flex:1; text-align:center;">${d.n}</div><div style="font-size:32px; color:#ffeb3b; width:55px; text-align:center;">${d.s}</div><div style="font-size:18px; color:#aaa; width:90px; text-align:right; font-weight:bold;">${d.t}(${d.e})</div></div>`;
    });
    const container = document.getElementById('mh-grid-container');
    container.style.display = 'grid'; container.style.gridTemplateColumns = '1fr'; container.style.gap = '6px';
    container.innerHTML = html;
  }

  function switchMode(m) { currentMode = m; resetAll(); }

  function initGrid() {
    const grid = document.getElementById('grid'); grid.innerHTML = '';
    const list = (currentMode === 'draw') ? [...pieces].sort(() => 0.5 - Math.random()) :
                 pieces.filter(p=>p.c==='red').sort((a,b)=>b.p-a.p).concat(pieces.filter(p=>p.c==='black').sort((a,b)=>b.p-a.p));
    list.forEach((p, i) => {
      let card = document.createElement('div');
      card.className = `card ${currentMode}-mode ${currentMode==='layout'?(i<16?'red-text':'black-text'):''}`;
      card.innerHTML = `<span class="seq"></span>${currentMode==='draw' ? i+1 : p.n}`;
      card.onclick = () => {
        if(selected.length < 5) {
          selected.push(p); card.classList.add('revealed');
          card.querySelector('.seq').innerText = selected.length;
          const target = document.getElementById(`v-${['mid','left','right','up','down'][selected.length-1]}`);
          target.innerText = p.n; target.className = `piece ${p.c}`; target.style.display = 'flex';
          if(selected.length === 5) showMath();
        }
      };
      grid.appendChild(card);
    });
  }

  function renderYaoBar(isYang) { return isYang ? '████████' : '███　　███'; }

  function showMath() {
    const sp = selected.reduce((s, p) => s + p.p, 0);
    const rp = selected.filter(p => p.c === 'red').reduce((s, p) => s + p.p, 0);
    const bp = selected.filter(p => p.c === 'black').reduce((s, p) => s + p.p, 0);
    const up = (sp+rp)%8||8, dn = (sp+bp)%8||8, mov = sp%6||6;

    document.getElementById('math-box').style.display = 'flex';
    document.getElementById('cur-date').innerText = getFormattedDate();

    let vIdx = sp % 32; if (vIdx === 0) vIdx = 32;
    const pRef = pieces.find(x => x.c === virtualPieces[vIdx].c && x.n === virtualPieces[vIdx].n);
    const vP = { n: virtualPieces[vIdx].n, c: virtualPieces[vIdx].c, t: pRef.t };

    let zsHtml = `<div class="gua-title">【六爻排盤】 <button class="btn-info" onclick="openModal('modal-zs')">表格</button></div>`;
    let yaoList = [...selected, vP];
    for(let i=5; i>=0; i--) {
      let p = yaoList[i];
      let isYang = p.c === 'red';
      let type = isYang ? (p.t==='old'?'老陽':'少陽') : (p.t==='old'?'老陰':'少陰');
      zsHtml += `<div class="yao-line ${p.t==='old'?'moving-yao':''}"><span class="yao-bar">${renderYaoBar(isYang)}</span><span class="yao-text">${i+1}爻: ${p.n}(${type})</span></div>`;
    }
    document.getElementById('zs-graph').innerHTML = zsHtml;

    let mhHtml = `<div class="gua-title">【梅花排盤】(${guaNames[up]}${guaNames[dn]}) <button class="btn-info" onclick="openModal('modal-mh')">表單</button></div>`;
    const fullGua = [...guaBars[dn], ...guaBars[up]]; 
    for(let i=5; i>=0; i--) {
      let isYang = fullGua[i] === 1;
      let mark = (i+1) === mov ? '(動爻)' : '　　　';
      mhHtml += `<div class="yao-line ${(i+1)===mov?'moving-yao':''}"><span class="yao-bar">${renderYaoBar(isYang)}</span><span class="yao-text">第${i+1}爻 ${mark}</span></div>`;
    }
    document.getElementById('mh-graph').innerHTML = mhHtml;
  }

  function generatePrompt(type) {
    if(selected.length < 5) return alert("請先選滿五個棋子！");
    const dateStr = document.getElementById('cur-date').innerText;
    const sub = document.getElementById('subject').value || "一般解卦";
    const gen = document.getElementById('gender').value;
    const mar = document.getElementById('marriage').value;
    const sp = selected.reduce((s, p) => s + p.p, 0);
    const rp = selected.filter(p => p.c === 'red').reduce((s, p) => s + p.p, 0);
    const bp = selected.filter(p => p.c === 'black').reduce((s, p) => s + p.p, 0);
    let vIdx = sp % 32; if (vIdx === 0) vIdx = 32;
    const vP = virtualPieces[vIdx];
    const xq = `【象棋卜卦】\n求問：${sub}\n方位：中(${selected[0].n})、左(${selected[1].n})、右(${selected[2].n})、上(${selected[3].n})、下(${selected[4].n})\n`;
    const mh = `【梅花易數】\n上卦：${guaNames[(sp+rp)%8||8]}，下卦：${guaNames[(sp+bp)%8||8]}，動爻：第${sp%6||6}爻\n`;
    const zs = `【六爻增刪】\n第六爻：${(vP.c==='red'?'紅':'黑')+vP.n}\n`;
    let final = `時間：${dateStr}\n問卜者：${gen}/${mar}\n\n`;
    if(type==='xq') final += xq; else if(type==='mh') final += mh; else if(type==='zs') final += zs; else final += xq + mh + zs;
    document.getElementById('output').value = final;
  }

  function resetAll() {
    selected = []; document.getElementById('output').value = '';
    document.getElementById('math-box').style.display = 'none';
    ['mid','left','right','up','down'].forEach(id => document.getElementById(`v-${id}`).style.display='none');
    initGrid();
  }

  function copyToClipboard() { 
    const o = document.getElementById('output');
    if(!o.value) return; o.select(); document.execCommand('copy'); 
    alert('提示詞已複製！'); 
  }

  function openModal(id) { document.getElementById(id).style.display = 'flex'; }
  function closeModal(e, id) { if(!e || e.target === e.currentTarget) document.getElementById(id).style.display = 'none'; }

  const tags = ["分數計算", "格局分析", "雙方關係", "問雙方緣分", "互動得好處?", "健康狀態", "適合度", "問好壞", "成功與否", "問可否", "問可能性", "問前世關係"];
  tags.forEach(t => {
    let b = document.createElement('span'); b.className = 'tag-btn'; b.innerText = t; 
    b.onclick = () => document.getElementById('subject').value = t;
    document.getElementById('tag-container').appendChild(b);
  });
  
  populateZSTable(); populateMHTable(); initGrid();
</script>
</body>
</html>
